name: ðŸŒ ProtonVPN Config Downloader & Telegram Uploader (Chrome)

on:
  workflow_dispatch:

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    
    env:
      VPN_USERNAME: ${{ secrets.VPN_USERNAME }}
      VPN_PASSWORD: ${{ secrets.VPN_PASSWORD }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # ðŸ Setup Python and Install Selenium
      - name: âš™ï¸ Setup Python and Install Selenium
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3 python3-pip zip 
          pip3 install selenium

      # ðŸŒ Install Chrome/Chromium and ChromeDriver
      - name: ðŸŒ Install Google Chrome and ChromeDriver
        uses: browser-actions/setup-chrome@latest
        with:
          # This action automatically downloads and sets up the correct version of ChromeDriver
          # and the Chrome browser, making it much more reliable than manual installation.
          chrome-version: 'stable' 
      
      # ðŸš€ Execute the Python script. Files are saved in downloaded_configs/.
      - name: ðŸƒ Execute ProtonVPN Downloader
        # Make sure to update the Python file name if you change it:
        run: python3 proton_downloader_chrome.py

      # --- Steps for Telegram Upload ---
      
      - name: ðŸ—œï¸ Compress Downloaded Files
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ZIP_FILENAME="configs_${TIMESTAMP}.zip"
          
          if [ -d "downloaded_configs" ] && [ "$(ls -A downloaded_configs)" ]; then
            zip -r "$ZIP_FILENAME" downloaded_configs/
            echo "ZIP_FILE=$ZIP_FILENAME" >> $GITHUB_ENV
          else
            echo "::warning::Download directory is empty or not found. Skipping Telegram upload."
            echo "ZIP_FILE=NOT_FOUND" >> $GITHUB_ENV
          fi

      - name: ðŸ“¬ Send Configs to Telegram Channel
        if: env.ZIP_FILE != 'NOT_FOUND'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_CHAT_ID }}
          token: ${{ env.TELEGRAM_BOT_TOKEN }}
          document: ${{ env.ZIP_FILE }}
          caption: |
            âœ… ProtonVPN Configs Downloaded Successfully!
            Generated by GitHub Action
            Actor: ${{ github.actor }}
          
      - name: âœ… Clean up
        if: always()
        run: rm -rf downloaded_configs *.zip
